# UI_STRUCTURE.md — Экраны и навигация Kabinet

## Карта экранов

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              AUTH FLOW                                  │
│  ┌──────────────┐     ┌──────────────┐     ┌──────────────┐            │
│  │ SplashScreen │────►│ LoginScreen  │────►│RegisterScreen│            │
│  │              │     │              │◄────│              │            │
│  └──────────────┘     └──────┬───────┘     └──────────────┘            │
│                              │                                          │
│                              ▼                                          │
└──────────────────────────────┼──────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         INSTITUTION FLOW                                │
│  ┌────────────────────┐     ┌────────────────────┐                     │
│  │InstitutionsListScr │────►│CreateInstitutionScr│                     │
│  │                    │     └────────────────────┘                     │
│  │ Список заведений   │────►┌────────────────────┐                     │
│  │ пользователя       │     │ JoinInstitutionScr │                     │
│  └─────────┬──────────┘     └────────────────────┘                     │
│            │ Tap на заведение                                           │
│            ▼                                                            │
└────────────┼────────────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           MAIN APP SHELL                                │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                         AppBar                                   │   │
│  │  [≡ Drawer]  [Название заведения ▼]              [Профиль]      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                  │   │
│  │                      Content Area                                │   │
│  │                   (вложенные экраны)                             │   │
│  │                                                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     Bottom Navigation                            │   │
│  │   [Главная]   [Кабинеты]   [Ученики]   [Оплаты]   [Ещё]         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

## Навигация (go_router)

### Структура роутов

```dart
GoRouter(
  initialLocation: '/splash',
  routes: [
    // Auth
    GoRoute(path: '/splash', builder: (_, __) => SplashScreen()),
    GoRoute(path: '/login', builder: (_, __) => LoginScreen()),
    GoRoute(path: '/register', builder: (_, __) => RegisterScreen()),
    
    // Institutions
    GoRoute(path: '/institutions', builder: (_, __) => InstitutionsListScreen()),
    GoRoute(path: '/institutions/create', builder: (_, __) => CreateInstitutionScreen()),
    GoRoute(path: '/join/:code', builder: (_, state) => JoinInstitutionScreen(code: state.pathParameters['code'])),
    
    // Main App Shell
    ShellRoute(
      builder: (_, __, child) => MainShell(child: child),
      routes: [
        GoRoute(
          path: '/i/:institutionId',
          redirect: (_, state) => '/i/${state.pathParameters['institutionId']}/dashboard',
        ),
        
        // Dashboard
        GoRoute(
          path: '/i/:institutionId/dashboard',
          builder: (_, state) => DashboardScreen(
            institutionId: state.pathParameters['institutionId']!,
          ),
        ),
        
        // Rooms & Schedule
        GoRoute(
          path: '/i/:institutionId/rooms',
          builder: (_, state) => RoomsListScreen(),
          routes: [
            GoRoute(
              path: ':roomId/schedule',
              builder: (_, state) => ScheduleScreen(
                roomId: state.pathParameters['roomId']!,
              ),
            ),
          ],
        ),
        
        // Students
        GoRoute(
          path: '/i/:institutionId/students',
          builder: (_, __) => StudentsListScreen(),
          routes: [
            GoRoute(
              path: ':studentId',
              builder: (_, state) => StudentDetailScreen(
                studentId: state.pathParameters['studentId']!,
              ),
            ),
          ],
        ),
        
        // Groups
        GoRoute(
          path: '/i/:institutionId/groups',
          builder: (_, __) => GroupsListScreen(),
          routes: [
            GoRoute(
              path: ':groupId',
              builder: (_, state) => GroupDetailScreen(
                groupId: state.pathParameters['groupId']!,
              ),
            ),
          ],
        ),
        
        // Payments
        GoRoute(
          path: '/i/:institutionId/payments',
          builder: (_, __) => PaymentsScreen(),
          routes: [
            GoRoute(
              path: 'add',
              builder: (_, __) => AddPaymentScreen(),
            ),
          ],
        ),
        
        // Statistics
        GoRoute(
          path: '/i/:institutionId/statistics',
          builder: (_, __) => StatisticsScreen(),
        ),
        
        // Settings
        GoRoute(
          path: '/i/:institutionId/settings',
          builder: (_, __) => SettingsScreen(),
          routes: [
            GoRoute(path: 'members', builder: (_, __) => MembersScreen()),
            GoRoute(path: 'subjects', builder: (_, __) => SubjectsScreen()),
            GoRoute(path: 'lesson-types', builder: (_, __) => LessonTypesScreen()),
            GoRoute(path: 'payment-plans', builder: (_, __) => PaymentPlansScreen()),
          ],
        ),
      ],
    ),
  ],
)
```

## Bottom Navigation

| Индекс | Иконка | Название | Роут |
|--------|--------|----------|------|
| 0 | Home | Главная | `/i/:id/dashboard` |
| 1 | Door | Кабинеты | `/i/:id/rooms` |
| 2 | People | Ученики | `/i/:id/students` |
| 3 | Wallet | Оплаты | `/i/:id/payments` |
| 4 | More | Ещё | Drawer или BottomSheet |

**"Ещё" содержит:**
- Группы
- Статистика
- Настройки

## Описание экранов

### Auth Flow

#### SplashScreen
- Проверка авторизации
- Редирект: авторизован → `/institutions`, нет → `/login`

#### LoginScreen
- Поля: email, пароль
- Кнопки: Войти, Google, Apple
- Ссылка: "Нет аккаунта? Зарегистрироваться"

#### RegisterScreen
- Поля: имя, email, пароль, подтверждение пароля
- Кнопки: Зарегистрироваться, Google, Apple
- Ссылка: "Уже есть аккаунт? Войти"

---

### Institution Flow

#### InstitutionsListScreen
- Список карточек заведений
- Каждая карточка: название, роль (Владелец/Участник)
- FAB: "+" с опциями "Создать" / "Присоединиться"
- Empty state если нет заведений

#### CreateInstitutionScreen
- Поле: название заведения
- Кнопка: Создать
- После успеха → переход в dashboard

#### JoinInstitutionScreen
- Поле ввода кода (или предзаполнено из deep link)
- Кнопка: Присоединиться
- Превью названия заведения после ввода кода

---

### Main App

#### DashboardScreen (Главная)

**Layout:**
```
┌─────────────────────────────────────┐
│ Сегодня, 15 января                  │
├─────────────────────────────────────┤
│ ┌─────────────────────────────────┐ │
│ │ Занятия сегодня            12 ▶│ │
│ └─────────────────────────────────┘ │
│ ┌─────────────────────────────────┐ │
│ │ Ближайшее занятие               │ │
│ │ 14:00 Каб. 5 — Иванов И.        │ │
│ │ Фортепиано (инд.)               │ │
│ └─────────────────────────────────┘ │
│ ┌─────────────────────────────────┐ │
│ │ Должники                     3 ▶│ │
│ │ Петров А. (-2), Сидоров Б. (-1) │ │
│ └─────────────────────────────────┘ │
│ ┌─────────────────────────────────┐ │
│ │ Сегодня оплачено                │ │
│ │ 45 000 ₸                        │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

**Компоненты:**
- `TodayLessonsCard` — количество занятий, tap → расписание
- `NextLessonCard` — ближайшее занятие
- `DebtorsCard` — ученики с отрицательным балансом
- `TodayPaymentsCard` — сумма оплат за сегодня

---

#### RoomsListScreen (Кабинеты)

**Layout:**
```
┌─────────────────────────────────────┐
│ Кабинеты                       [+] │
├─────────────────────────────────────┤
│ ┌─────────────────────────────────┐ │
│ │ 🚪 Кабинет 1                  ▶ │ │
│ │    Фортепианный                 │ │
│ └─────────────────────────────────┘ │
│ ┌─────────────────────────────────┐ │
│ │ 🚪 Кабинет 2                  ▶ │ │
│ │    Вокальный                    │ │
│ └─────────────────────────────────┘ │
│ ┌─────────────────────────────────┐ │
│ │ 🚪 Кабинет 3                  ▶ │ │
│ │    Групповые занятия            │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

**Действия:**
- Tap на кабинет → ScheduleScreen
- [+] → создание кабинета (если есть права `manage_rooms`)
- Long press / Swipe → редактирование/архивация (если есть права `manage_rooms`)
- Drag & drop для изменения порядка сортировки (если есть права)

---

#### ScheduleScreen (Расписание кабинета)

**Layout:**
```
┌─────────────────────────────────────┐
│ ← Кабинет 1        [📅] [Сегодня]  │
├─────────────────────────────────────┤
│ ◀  Пн  Вт  Ср  Чт  Пт  Сб  Вс  ▶  │
│        15  16  17  18  19  20      │
│            ●                        │
├─────────────────────────────────────┤
│ 08:00 │                             │
│ ──────┼─────────────────────────────│
│ 09:00 │ ┌─────────────────────────┐ │
│       │ │ Иванов И.               │ │
│ 10:00 │ │ Фортепиано (инд.)       │ │
│       │ │ Петрова М.              │ │
│ ──────┼─└─────────────────────────┘ │
│ 11:00 │                             │
│ ──────┼─────────────────────────────│
│ 12:00 │ ┌─────────────────────────┐ │
│       │ │ Группа сольфеджио       │ │
│ 13:00 │ │ Сольфеджио (групп.)     │ │
│       │ │ Сидорова А.             │ │
│ ──────┼─└─────────────────────────┘ │
│ 14:00 │                             │
└───────┴─────────────────────────────┘
```

**Компоненты:**
- `WeekDaySelector` — горизонтальный скролл дней с точками (есть занятия)
- `TimeGrid` — вертикальная временная сетка
- `LessonBlock` — блок занятия на сетке
  - Высота пропорциональна длительности

**Цвет блока занятия:**
- Если у занятия есть предмет (subject) — используется цвет предмета
- Если предмета нет — используется цвет типа занятия (lesson_type)
- Если ни того, ни другого — дефолтный цвет (primary)

**Действия:**
- Tap на LessonBlock → LessonDetailBottomSheet
- Tap на пустое место → CreateLessonBottomSheet
- [📅] → DatePickerDialog
- [Сегодня] → переход на текущую дату

---

#### LessonDetailBottomSheet

**Layout:**
```
┌─────────────────────────────────────┐
│ ━━━━━━━━━━ (drag handle)            │
│                                     │
│ Индивидуальное занятие              │
│ ■ Фортепиано (предмет)              │
│ Тип: Индивидуальный урок            │
│                                     │
│ 📅 15 января 2025                   │
│ 🕐 09:00 — 10:00 (60 мин)           │
│ 🚪 Кабинет 1                        │
│ 👤 Петрова Мария                    │
│ 👨‍🏫 Иванов Иван                     │
│                                     │
│ Статус: Запланировано               │
│                                     │
│ Комментарий:                        │
│ Повторить гаммы до-мажор            │
│                                     │
├─────────────────────────────────────┤
│ [Проведено] [Отменить] [Изменить]   │
│                                     │
│ [История изменений]                 │
└─────────────────────────────────────┘
```

---

#### CreateLessonBottomSheet / CreateLessonScreen

**Layout:**
```
┌─────────────────────────────────────┐
│ Новое занятие                    ✕ │
├─────────────────────────────────────┤
│                                     │
│ Предмет *        (если несколько)   │
│ ┌─────────────────────────────────┐ │
│ │ Фортепиано                    ▼ │ │
│ └─────────────────────────────────┘ │
│                                     │
│ Тип занятия *                       │
│ ┌─────────────────────────────────┐ │
│ │ Выберите тип...               ▼ │ │
│ └─────────────────────────────────┘ │
│                                     │
│ ○ Индивидуальное  ● Групповое      │
│                                     │
│ Ученик / Группа *                   │
│ ┌─────────────────────────────────┐ │
│ │ Выберите...                   ▼ │ │
│ └─────────────────────────────────┘ │
│                                     │
│ Дата *                Время *       │
│ ┌───────────────┐    ┌────────────┐ │
│ │ 15.01.2025    │    │ 09:00      │ │
│ └───────────────┘    └────────────┘ │
│                                     │
│ Длительность                        │
│ [30] [45] [60] [90] [Другая: ___]   │
│                                     │
│ Комментарий                         │
│ ┌─────────────────────────────────┐ │
│ │                                 │ │
│ └─────────────────────────────────┘ │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │          СОЗДАТЬ                │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

**Логика выбора предмета:**
- Если у преподавателя один предмет — подставляется автоматически, но можно очистить
- Если несколько предметов — выбор из списка его предметов
- Если у преподавателя нет предметов — поле скрыто
- Предмет опционален (заведение может не использовать предметы)

**Предупреждение о конфликте:**
```
┌─────────────────────────────────────┐
│ ⚠️ Внимание                         │
│                                     │
│ В это время кабинет уже занят:      │
│ 09:00-10:00 — Сидоров А.            │
│                                     │
│ Создать занятие всё равно?          │
│                                     │
│      [Отмена]        [Создать]      │
└─────────────────────────────────────┘
```

---

#### StudentsListScreen

**Layout:**
```
┌─────────────────────────────────────┐
│ Ученики                   🔍   [+] │
├─────────────────────────────────────┤
│ ┌─────────────────────────────────┐ │
│ │ Петрова Мария              ▶    │ │
│ │ 📚 5 занятий                    │ │
│ └─────────────────────────────────┘ │
│ ┌─────────────────────────────────┐ │
│ │ Сидоров Алексей            ▶    │ │
│ │ ⚠️ -2 занятия                   │ │ ← красный, долг
│ └─────────────────────────────────┘ │
│ ┌─────────────────────────────────┐ │
│ │ Козлова Анна               ▶    │ │
│ │ 📚 0 занятий                    │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

**Фильтры (chips):**
- Все
- С долгом
- Архив

---

#### StudentDetailScreen

**Layout:**
```
┌─────────────────────────────────────┐
│ ← Петрова Мария              [✏️]  │
├─────────────────────────────────────┤
│                                     │
│ 📱 +7 (777) 123-45-67               │
│                                     │
│ Комментарий:                        │
│ Готовится к конкурсу                │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │      ПРЕДОПЛАЧЕНО ЗАНЯТИЙ       │ │
│ │              5                  │ │
│ │        [Добавить оплату]        │ │
│ └─────────────────────────────────┘ │
│                                     │
│ ─────── История занятий ────────    │
│                                     │
│ 15.01 09:00 Фортепиано ✓ Проведено │
│ 12.01 09:00 Фортепиано ✓ Проведено │
│ 08.01 09:00 Фортепиано ✕ Отменено  │
│                                     │
│ ─────── История оплат ──────────    │
│                                     │
│ 10.01 20 000 ₸ (8 занятий)         │
│ 01.12 20 000 ₸ (8 занятий)         │
│                                     │
└─────────────────────────────────────┘
```

---

#### PaymentsScreen

**Layout:**
```
┌─────────────────────────────────────┐
│ Оплаты                         [+] │
├─────────────────────────────────────┤
│ Период: [Январь 2025 ▼]            │
│                                     │
│ Итого: 145 000 ₸                    │
├─────────────────────────────────────┤
│ 15 января                           │
│ ┌─────────────────────────────────┐ │
│ │ Петрова М.      20 000 ₸        │ │
│ │ Абонемент 8     8 занятий       │ │
│ └─────────────────────────────────┘ │
│ ┌─────────────────────────────────┐ │
│ │ Козлова А.      15 000 ₸        │ │
│ │ Произвольная    6 занятий       │ │
│ └─────────────────────────────────┘ │
│                                     │
│ 12 января                           │
│ ┌─────────────────────────────────┐ │
│ │ Сидоров А.      20 000 ₸        │ │
│ │ Абонемент 8     8 занятий       │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

---

#### SettingsScreen

**Layout:**
```
┌─────────────────────────────────────┐
│ Настройки                           │
├─────────────────────────────────────┤
│                                     │
│ ЗАВЕДЕНИЕ                           │
│ ┌─────────────────────────────────┐ │
│ │ Название                      ▶ │ │
│ │ Музыкальная школа №1            │ │
│ └─────────────────────────────────┘ │
│ ┌─────────────────────────────────┐ │
│ │ Пригласить участника          ▶ │ │
│ │ Код: ABC12345                   │ │
│ └─────────────────────────────────┘ │
│                                     │
│ УПРАВЛЕНИЕ                          │
│ ┌─────────────────────────────────┐ │
│ │ 👥 Участники                  ▶ │ │
│ └─────────────────────────────────┘ │
│ ┌─────────────────────────────────┐ │
│ │ 🎹 Предметы                   ▶ │ │
│ └─────────────────────────────────┘ │
│ ┌─────────────────────────────────┐ │
│ │ 📝 Типы занятий               ▶ │ │
│ └─────────────────────────────────┘ │
│ ┌─────────────────────────────────┐ │
│ │ 💳 Тарифы оплаты              ▶ │ │
│ └─────────────────────────────────┘ │
│                                     │
│ АККАУНТ                             │
│ ┌─────────────────────────────────┐ │
│ │ Профиль                       ▶ │ │
│ └─────────────────────────────────┘ │
│ ┌─────────────────────────────────┐ │
│ │ 🚪 Выйти                        │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

---

## Общие компоненты (lib/core/widgets/)

| Компонент | Описание |
|-----------|----------|
| `LoadingOverlay` | Полупрозрачный оверлей с индикатором загрузки |
| `ErrorView` | Сообщение об ошибке с кнопкой "Повторить" |
| `EmptyState` | Заглушка для пустых списков с иконкой и текстом |
| `ConfirmationDialog` | Диалог подтверждения действия |
| `CustomAppBar` | AppBar с поддержкой переключения заведений |
| `SearchField` | Поле поиска с debounce |
| `DateRangePicker` | Выбор периода дат |
| `PermissionGate` | Виджет, скрывающий контент без нужных прав |

---

## Тема и стили

### Цветовая палитра (предложение)

```dart
class AppColors {
  // Primary
  static const primary = Color(0xFF6366F1);      // Indigo
  static const primaryLight = Color(0xFF818CF8);
  static const primaryDark = Color(0xFF4F46E5);
  
  // Status
  static const success = Color(0xFF22C55E);      // Green
  static const warning = Color(0xFFF59E0B);      // Amber
  static const error = Color(0xFFEF4444);        // Red
  
  // Lesson types (defaults)
  static const lessonIndividual = Color(0xFF3B82F6);  // Blue
  static const lessonGroup = Color(0xFF8B5CF6);       // Purple
  
  // Background
  static const background = Color(0xFFF9FAFB);
  static const surface = Colors.white;
  static const surfaceVariant = Color(0xFFF3F4F6);
  
  // Text
  static const textPrimary = Color(0xFF111827);
  static const textSecondary = Color(0xFF6B7280);
  static const textTertiary = Color(0xFF9CA3AF);
}
```

### Типографика

```dart
class AppTextStyles {
  static const headline1 = TextStyle(fontSize: 24, fontWeight: FontWeight.bold);
  static const headline2 = TextStyle(fontSize: 20, fontWeight: FontWeight.w600);
  static const headline3 = TextStyle(fontSize: 18, fontWeight: FontWeight.w600);
  static const body1 = TextStyle(fontSize: 16, fontWeight: FontWeight.normal);
  static const body2 = TextStyle(fontSize: 14, fontWeight: FontWeight.normal);
  static const caption = TextStyle(fontSize: 12, fontWeight: FontWeight.normal);
  static const button = TextStyle(fontSize: 16, fontWeight: FontWeight.w600);
}
```
