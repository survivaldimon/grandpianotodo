# CLAUDE.md — Главный файл инструкций для Claude Code

## О проекте

**Kabinet** — мобильное приложение для управления расписанием кабинетов в частных учебных заведениях (музыкальные школы, языковые курсы, танцевальные студии и т.д.).

## Технологический стек

| Компонент | Технология |
|-----------|------------|
| Framework | Flutter (Dart) |
| State Management | Riverpod |
| Backend | Supabase (PostgreSQL + Auth + Realtime) |
| Навигация | go_router |
| Аутентификация | Supabase Auth (Email, Google, Apple) |
| Локализация | Только русский язык |

## Структура документации

Перед началом работы над любой фичей, **обязательно прочитай**:

1. **[ARCHITECTURE.md](./ARCHITECTURE.md)** — архитектура приложения, паттерны, структура папок
2. **[DATABASE.md](./DATABASE.md)** — схема БД Supabase, RLS policies, связи таблиц
3. **[FEATURES.md](./FEATURES.md)** — описание фич с acceptance criteria
4. **[UI_STRUCTURE.md](./UI_STRUCTURE.md)** — экраны, навигация, компоненты
5. **[MODELS.md](./MODELS.md)** — Dart модели данных

## Валюта

Приложение использует **казахстанский тенге (₸)** в качестве валюты. Валюта фиксирована и не настраивается.

## Ключевые принципы разработки

### 1. Feature-first структура
Каждая фича изолирована в своей папке внутри `lib/features/`. Не создавай зависимости между фичами напрямую — используй `core/` и `shared/`.

### 2. Riverpod паттерны
- Используй `StreamProvider` для realtime данных из Supabase
- Используй `FutureProvider` для одноразовых запросов
- Используй `StateNotifierProvider` для локального состояния с мутациями
- Все провайдеры должны быть в файле `providers/` соответствующей фичи

### 3. Repository Pattern
```
UI (Screen/Widget) → Provider → Repository → Supabase
```
Провайдеры не должны напрямую обращаться к Supabase. Создавай репозитории в `lib/features/{feature}/repositories/`.

### 4. Обработка ошибок
- Все репозитории возвращают `Either<Failure, T>` или используют try-catch с кастомными exceptions
- UI показывает user-friendly сообщения на русском языке
- Логируй ошибки для отладки

### 5. Realtime
- Подписки на Supabase Realtime создаются через `StreamProvider`
- При уходе с экрана подписки автоматически отменяются (Riverpod это делает)
- Используй `.family` модификатор для параметризованных провайдеров

### 6. Архивация vs Удаление
- "Удаление" сущностей = установка `archived_at` timestamp
- Полное удаление доступно только для архивированных записей
- Все запросы по умолчанию фильтруют `WHERE archived_at IS NULL`

### 7. История изменений
- Только для занятий (lessons)
- При любом изменении создаётся запись в `lesson_history`
- Храним: кто изменил, когда, что было до, что стало после

## Команды

```bash
# Запуск приложения
flutter run

# Генерация кода (после изменения моделей/роутов)
flutter pub run build_runner build --delete-conflicting-outputs

# Тесты
flutter test

# Анализ кода
flutter analyze
```

## Порядок работы над задачей

1. Прочитай соответствующие разделы документации
2. Определи, какие файлы нужно создать/изменить
3. Начни с модели данных (если новая сущность)
4. Создай/обнови репозиторий
5. Создай/обнови провайдер
6. Создай/обнови UI
7. Протестируй на реальных данных

## Важные ограничения

- **НЕ** используй `setState` — только Riverpod
- **НЕ** обращайся к Supabase напрямую из виджетов
- **НЕ** хардкодь строки — используй константы в `lib/core/constants/`
- **НЕ** создавай виджеты больше 200 строк — декомпозируй
- **НЕ** игнорируй RLS — все данные фильтруются на уровне БД

## Контакты

При возникновении вопросов по бизнес-логике — спрашивай у пользователя.
