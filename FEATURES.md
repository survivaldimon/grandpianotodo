# FEATURES.md — Описание функциональности Kabinet

## Обзор модулей

| Модуль | Описание | Приоритет |
|--------|----------|-----------|
| Auth | Аутентификация (email, Google, Apple) | P0 |
| Institution | Создание/присоединение к заведению | P0 |
| Rooms | Управление кабинетами | P0 |
| Subjects | Предметы/направления | P0 |
| Schedule | Расписание и занятия | P0 |
| Students | Ученики и группы | P0 |
| Payments | Оплаты и предоплаченные занятия | P1 |
| Subscriptions | Абонементы учеников | P1 |
| Statistics | Статистика и отчёты | P1 |
| Settings | Настройки заведения | P1 |

---

## 1. Auth — Аутентификация

### 1.1 Регистрация

**Описание:** Новый пользователь создаёт аккаунт.

**Способы:**
- Email + пароль
- Google OAuth
- Apple Sign In

**Acceptance Criteria:**
- [ ] Форма с полями: имя, email, пароль (для email-регистрации)
- [ ] Валидация email формата
- [ ] Пароль минимум 8 символов
- [ ] Кнопки "Войти через Google" и "Войти через Apple"
- [ ] После успешной регистрации — редирект на выбор/создание заведения
- [ ] Обработка ошибок: email занят, слабый пароль, ошибка OAuth

### 1.2 Вход

**Описание:** Существующий пользователь входит в аккаунт.

**Acceptance Criteria:**
- [ ] Форма: email, пароль
- [ ] Кнопки OAuth
- [ ] "Забыл пароль" — отправка ссылки на сброс
- [ ] После входа — редирект на список заведений или последнее открытое

### 1.3 Выход

**Acceptance Criteria:**
- [ ] Кнопка в настройках профиля
- [ ] Очистка локального состояния
- [ ] Редирект на экран входа

---

## 2. Institution — Заведения

### 2.1 Создание заведения

**Описание:** Пользователь создаёт новое заведение и становится его владельцем.

**Acceptance Criteria:**
- [ ] Поле: название заведения (обязательное)
- [ ] После создания — автоматически генерируется invite_code
- [ ] Создатель получает все права (owner)
- [ ] Редирект на dashboard нового заведения

### 2.2 Присоединение к заведению

**Описание:** Пользователь присоединяется по invite-коду или ссылке.

**Acceptance Criteria:**
- [ ] Поле ввода кода ИЛИ обработка deep link `/join/:code`
- [ ] Валидация: код существует, не архивирован
- [ ] При успехе — добавление в institution_members с дефолтными правами
- [ ] Редирект на dashboard заведения
- [ ] Ошибка если уже состоит в этом заведении

### 2.3 Список заведений

**Описание:** Пользователь видит все свои заведения.

**Acceptance Criteria:**
- [ ] Список карточек с названиями
- [ ] Индикатор роли (владелец/участник)
- [ ] Кнопка "Создать заведение"
- [ ] Кнопка "Присоединиться"
- [ ] Tap на карточку — переход в dashboard

### 2.4 Переключение между заведениями

**Acceptance Criteria:**
- [ ] Доступно из любого экрана (drawer или кнопка в AppBar)
- [ ] При переключении — обновление всех данных

---

## 3. Rooms — Кабинеты

### 3.1 Список кабинетов

**Описание:** Отображение всех кабинетов заведения.

**Acceptance Criteria:**
- [ ] Список с названием и номером каждого кабинета
- [ ] Сортировка по sort_order
- [ ] Tap — переход к расписанию кабинета
- [ ] Кнопка добавления (если есть права)

### 3.2 Создание кабинета

**Права:** `manage_rooms`

**Acceptance Criteria:**
- [ ] Поля: название (обязательное), номер (опционально)
- [ ] Валидация: название не пустое
- [ ] После создания — появляется в списке

### 3.3 Редактирование кабинета

**Права:** `manage_rooms`

**Acceptance Criteria:**
- [ ] Изменение названия и номера
- [ ] Сохранение изменений

### 3.4 Архивация/удаление кабинета

**Права:** `manage_rooms` + `archive_data`

**Acceptance Criteria:**
- [ ] Архивация: кабинет скрывается из списка, но данные сохраняются
- [ ] При архивации — предупреждение о связанных занятиях
- [ ] Удаление: только для архивированных, с подтверждением
- [ ] Удаление каскадно архивирует связанные занятия

---

## 4. Subjects — Предметы/Направления

### 4.1 Список предметов

**Описание:** Предметы заведения (Фортепиано, Вокал, Гитара и т.д.)

**Acceptance Criteria:**
- [ ] Список всех предметов заведения
- [ ] Название и цвет каждого предмета
- [ ] Количество преподавателей по каждому предмету
- [ ] Кнопка добавления (если есть права)

### 4.2 Создание предмета

**Права:** `manage_subjects`

**Acceptance Criteria:**
- [ ] Поля: название (обязательное), цвет (выбор из палитры)
- [ ] Валидация: название уникально в рамках заведения

### 4.3 Редактирование предмета

**Права:** `manage_subjects`

**Acceptance Criteria:**
- [ ] Изменение названия и цвета
- [ ] Просмотр списка преподавателей по предмету

### 4.4 Назначение предметов преподавателю

**Права:** `manage_members`

**Acceptance Criteria:**
- [ ] В профиле участника — выбор предметов (multiple)
- [ ] Преподаватель может вести несколько предметов
- [ ] При удалении предмета у преподавателя — предупреждение о связанных занятиях

### 4.5 Архивация/удаление предмета

**Права:** `manage_subjects` + `archive_data`

**Acceptance Criteria:**
- [ ] Архивация: предмет скрывается, история сохраняется
- [ ] При архивации — предупреждение о связанных преподавателях и занятиях

---

## 5. Schedule — Расписание

### 5.1 Просмотр расписания кабинета

**Описание:** Сетка расписания на выбранный день.

**Acceptance Criteria:**
- [ ] Выбор даты (по умолчанию — сегодня)
- [ ] Календарь для быстрого перехода к дате
- [ ] Временная сетка (например, 8:00 — 22:00)
- [ ] Занятия отображаются как блоки на сетке
- [ ] Цвет блока = цвет типа занятия
- [ ] На блоке: время, имя ученика/группы, имя преподавателя
- [ ] Tap на блок — детали занятия
- [ ] Tap на пустой слот — создание занятия (если есть права)

### 5.2 Создание занятия

**Права:** `create_lessons`

**Acceptance Criteria:**
- [ ] Выбор типа занятия (из lesson_types)
- [ ] Выбор предмета:
  - [ ] Если у преподавателя один предмет — подставляется автоматически
  - [ ] Если несколько предметов — выбор из списка его предметов
- [ ] Выбор: индивидуальное (ученик) или групповое (группа)
- [ ] Выбор ученика ИЛИ группы
- [ ] Дата (предзаполнена из контекста)
- [ ] Время начала
- [ ] Длительность: выбор из стандартных (30/45/60/90 мин) + произвольная
- [ ] Автоматический расчёт времени окончания
- [ ] Комментарий (опционально)
- [ ] Преподаватель = текущий пользователь (или выбор, если есть права)
- [ ] Проверка конфликтов:
  - [ ] Предупреждение если кабинет занят
  - [ ] Предупреждение если преподаватель занят
  - [ ] Возможность всё равно создать (подтверждение)
- [ ] После создания — занятие появляется на сетке

### 5.3 Просмотр деталей занятия

**Acceptance Criteria:**
- [ ] Полная информация: тип, ученик/группа, преподаватель, время, статус
- [ ] Комментарий
- [ ] Кнопки действий (в зависимости от прав):
  - [ ] Редактировать
  - [ ] Отметить проведённым
  - [ ] Отменить
  - [ ] История изменений

### 5.4 Редактирование занятия

**Права:** `edit_own_lessons` (свои) или `edit_all_lessons` (все)

**Acceptance Criteria:**
- [ ] Изменение всех полей (кроме создателя)
- [ ] Проверка конфликтов при изменении времени/кабинета
- [ ] Автоматическая запись в lesson_history

### 5.5 Изменение статуса занятия

**Статусы:**
- `scheduled` — запланировано (по умолчанию)
- `completed` — проведено
- `cancelled` — отменено
- `rescheduled` — перенесено (меняется автоматически при изменении даты/времени)

**Acceptance Criteria:**
- [ ] Кнопка "Отметить проведённым" → `completed`
- [ ] Кнопка "Отменить" → `cancelled`
- [ ] При `completed` или `cancelled`:
  - [ ] Списание предоплаченного занятия у ученика (индивидуальное)
  - [ ] Списание у всех присутствовавших (групповое)
- [ ] Запись в историю

### 5.6 История изменений занятия

**Acceptance Criteria:**
- [ ] Список всех изменений в хронологическом порядке
- [ ] Каждая запись: кто изменил, когда, что изменилось
- [ ] Понятное отображение изменений ("Время: 15:00 → 16:00")

### 5.7 Управление участниками группового занятия

**Описание:** Для группового занятия можно отметить присутствие каждого ученика.

**Acceptance Criteria:**
- [ ] Список учеников группы
- [ ] Чекбокс "Присутствовал" для каждого
- [ ] По умолчанию все присутствуют
- [ ] Отсутствующие (attended=false) НЕ теряют предоплаченное занятие
- [ ] Присутствующие (attended=true) теряют предоплаченное занятие при завершении/отмене занятия
- [ ] При отмене всего занятия (статус cancelled) — списывается у всех, кто был отмечен как присутствующий

### 5.8 Повторяющиеся занятия ✅

**Описание:** Занятия могут быть частью серии с `repeat_group_id`.

**Acceptance Criteria:**
- [x] При создании можно указать повторение (ежедневно, еженедельно, по дням недели)
- [x] Все занятия серии связаны через `repeat_group_id`
- [x] При создании — проверка конфликтов для всех дат
- [x] При редактировании времени — диалог с опциями:
  - [x] "Только это" — изменить только текущее занятие
  - [x] "Это и последующие" — изменить все занятия после текущей даты
- [x] Подсчёт количества будущих занятий в серии

---

## 6. Students — Ученики

### 6.1 Список учеников

**Acceptance Criteria:**
- [x] Список с именами
- [x] Показ количества предоплаченных занятий
- [x] Индикатор долга (отрицательный баланс) — выделение цветом
- [ ] Поиск по имени
- [x] Фильтр: все / мои ученики / с долгом / архивированные
- [x] Tap — переход к профилю ученика

### 6.2 Создание ученика

**Права:** `manage_students`

**Acceptance Criteria:**
- [ ] Поля: имя (обязательное), телефон, комментарий
- [ ] После создания — prepaid_lessons_count = 0

### 6.3 Профиль ученика

**Acceptance Criteria:**
- [ ] Информация: имя, телефон, комментарий
- [ ] Количество предоплаченных занятий (может быть отрицательным = долг)
- [ ] История занятий (список)
- [ ] История оплат (список)
- [ ] Кнопки: редактировать, добавить оплату, архивировать

### 6.4 Редактирование ученика

**Права:** `manage_students`

**Acceptance Criteria:**
- [ ] Изменение имени, телефона, комментария
- [ ] Ручная корректировка prepaid_lessons_count (с подтверждением)

### 6.5 Архивация/удаление ученика

**Права:** `manage_students` + `archive_data`

**Acceptance Criteria:**
- [ ] Архивация: ученик скрывается, история сохраняется
- [ ] Удаление: только архивированных, с подтверждением

### 6.6 Привязки ученика (преподаватели и предметы)

**Описание:** Система привязок позволяет связывать учеников с преподавателями и предметами для автоматизации создания занятий.

**Таблицы БД:**
- `student_teachers` — связь ученик ↔ преподаватель (many-to-many)
- `student_subjects` — связь ученик ↔ предмет (many-to-many)

**Acceptance Criteria:**

**В профиле ученика:**
- [x] Секция "Преподаватели" — список привязанных преподавателей
- [x] Секция "Предметы" — список привязанных предметов
- [x] Кнопка добавления преподавателя/предмета → модальное окно с выбором
- [x] Удаление привязки через иконку X на чипе

**При создании занятия:**
- [x] При выборе ученика — автозаполнение из последнего занятия этого ученика:
  - Предмет
  - Тип занятия
  - Преподаватель
  - Длительность (время окончания)
- [x] Автоматическое сохранение можно изменить на любые другие значения

**Автоматическое создание привязок:**
- [x] При создании занятия автоматически создаются привязки:
  - ученик → преподаватель (если ещё нет)
  - ученик → предмет (если выбран и ещё нет)
- [x] Используется upsert — повторные занятия не создают дубликаты

**Фильтр "Мои ученики":**
- [x] В списке учеников доступен фильтр "Мои"
- [x] Показывает только учеников, привязанных к текущему преподавателю

---

## 7. Groups — Группы учеников

### 7.1 Список групп

**Acceptance Criteria:**
- [ ] Список с названиями
- [ ] Количество учеников в каждой группе
- [ ] Tap — детали группы

### 7.2 Создание группы

**Права:** `manage_groups`

**Acceptance Criteria:**
- [ ] Название (обязательное)
- [ ] Комментарий
- [ ] Выбор учеников для добавления

### 7.3 Детали группы

**Acceptance Criteria:**
- [ ] Название, комментарий
- [ ] Список участников
- [ ] Кнопки: добавить/удалить участника, редактировать, архивировать
- [ ] История занятий группы

### 7.4 Редактирование состава группы

**Права:** `manage_groups`

**Acceptance Criteria:**
- [ ] Добавление учеников из общего списка
- [ ] Удаление учеников из группы

---

## 8. Payments — Оплаты

### 8.1 Список оплат

**Права:** `view_payments`

**Acceptance Criteria:**
- [ ] Список оплат в хронологическом порядке (новые сверху)
- [ ] Каждая запись: дата, ученик, сумма, количество занятий
- [ ] Фильтр по периоду (день, неделя, месяц, произвольный)
- [ ] Фильтр по ученику

### 8.2 Добавление оплаты

**Права:** `manage_payments`

**Acceptance Criteria:**
- [ ] Выбор ученика (обязательно)
- [ ] Выбор тарифа (payment_plan) ИЛИ ввод произвольно:
  - [ ] Сумма
  - [ ] Количество занятий
- [ ] При выборе тарифа — автозаполнение суммы и количества
- [ ] Комментарий (опционально)
- [ ] После сохранения:
  - [ ] Создаётся запись в payments
  - [ ] Увеличивается prepaid_lessons_count ученика

### 8.3 Модели оплаты (Payment Plans)

**Права:** `manage_payment_plans`

**Acceptance Criteria:**
- [ ] Список тарифов заведения
- [ ] Создание: название, цена, количество занятий
- [ ] Редактирование
- [ ] Архивация (не удаление — для сохранения истории)

### 8.4 Корректировка оплаты

**Описание:** Исправление ошибочно внесённой оплаты через корректирующую запись.

**Права:** `manage_payments`

**Acceptance Criteria:**
- [ ] Нельзя удалить существующую оплату
- [ ] Для исправления создаётся корректирующая запись с отрицательной суммой и количеством занятий
- [ ] Обязательное поле "Причина корректировки"
- [ ] Корректировка уменьшает prepaid_lessons_count ученика
- [ ] В истории оплат корректировки отображаются особым образом (другой цвет/иконка)
- [ ] Валидация: сумма и количество занятий должны быть отрицательными

---

## 9. Subscriptions — Абонементы ✅

**Описание:** Система абонементов для учеников. Абонемент — это пакет занятий, купленный заранее.

### 9.1 Покупка абонемента

**Acceptance Criteria:**
- [x] Выбор ученика
- [x] Выбор тарифа (payment_plan) с ценой и количеством занятий
- [x] Или ввод произвольных значений
- [x] Создаётся запись в `student_subscriptions`
- [x] Создаётся запись в `payments`

### 9.2 Просмотр абонементов ученика

**Acceptance Criteria:**
- [x] На экране ученика — виджет с активными абонементами
- [x] Показ: название тарифа, осталось/всего занятий, дата покупки
- [x] Realtime обновление при списании/возврате занятий
- [x] Индикатор если занятия закончились (0 из N)

### 9.3 Интеграция с занятиями

**Acceptance Criteria:**
- [x] При отметке занятия "проведено" — автоматически списывается 1 занятие с активного абонемента
- [x] При снятии отметки "проведено" — занятие возвращается на абонемент
- [x] Если у ученика нет активного абонемента — используется `prepaid_lessons_count`

---

## 10. Statistics — Статистика

**Права:** `view_statistics`

### 10.1 Общая статистика ✅

**Acceptance Criteria:**
- [x] Выбор периода (день, неделя, месяц, квартал, год, произвольный)
- [x] Навигация по периодам (стрелки вперёд/назад)
- [x] Показатели:
  - [x] Количество проведённых занятий
  - [x] Количество отменённых занятий
  - [x] Количество запланированных занятий
  - [x] Общая сумма оплат
  - [x] **Средняя стоимость занятия** (точная или ≈ приблизительная)
  - [x] Сумма скидок
  - [x] Количество оплаченных занятий
  - [x] Загруженность кабинетов (часы)
  - [x] Количество активных учеников

### 10.2 Статистика по предметам ✅

**Acceptance Criteria:**
- [x] Список предметов с количеством занятий за период
- [x] Доля каждого предмета в общем количестве занятий (%)
- [x] **Средняя стоимость занятия** по каждому предмету
- [x] Цветовая индикация по цвету предмета

### 10.3 Статистика по преподавателям ✅

**Acceptance Criteria:**
- [x] Список преподавателей
- [x] Для каждого: количество занятий за период, предметы
- [x] **Средняя стоимость занятия** по каждому преподавателю

### 10.4 Статистика по ученикам ✅

**Acceptance Criteria:**
- [x] Топ учеников по количеству занятий
- [x] Список должников (отрицательный prepaid_lessons_count)
- [x] Медали для топ-3 (золото, серебро, бронза)

### 10.5 Статистика по тарифам ✅

**Acceptance Criteria:**
- [x] Список тарифов с количеством покупок
- [x] Общая сумма и количество занятий по каждому тарифу
- [x] Секция скидок: количество оплат со скидкой, общая сумма скидок

### 10.6 Средняя стоимость занятия в карточке ученика ✅

**Acceptance Criteria:**
- [x] В карточке ученика показывается средняя стоимость его занятия
- [x] Расчёт: оплаты ученика / завершённые занятия ученика
- [x] Показ ≈ если используется приблизительный расчёт

---

## 11. Settings — Настройки

### 11.1 Настройки заведения

**Права:** `manage_institution`

**Acceptance Criteria:**
- [ ] Изменение названия
- [ ] Просмотр/обновление invite-кода
- [ ] Кнопка "Поделиться ссылкой для присоединения"

### 11.2 Управление участниками

**Права:** `manage_members`

**Acceptance Criteria:**
- [ ] Список всех участников заведения
- [ ] Для каждого: имя, роль, предметы, дата присоединения
- [ ] Редактирование прав (чекбоксы для каждого permission)
- [ ] Назначение предметов преподавателю
- [ ] Изменение названия роли
- [ ] Удаление из заведения (кроме владельца)

### 11.3 Предметы (Subjects)

**Права:** `manage_subjects`

**Acceptance Criteria:**
- [ ] Список предметов заведения
- [ ] Создание: название, цвет
- [ ] Редактирование
- [ ] Архивация

### 11.4 Типы занятий (Lesson Types)

**Права:** `manage_lesson_types`

**Acceptance Criteria:**
- [ ] Список типов занятий
- [ ] Создание: название, длительность по умолчанию, цена, групповое/индивидуальное, цвет
- [ ] Редактирование
- [ ] Архивация

### 11.5 Настройки профиля пользователя

**Acceptance Criteria:**
- [ ] Изменение имени
- [ ] Выход из аккаунта

---

## Порядок разработки (рекомендуемый)

### Фаза 1: Основа
1. Auth (регистрация, вход)
2. Institution (создание, присоединение)
3. Базовый роутинг

### Фаза 2: Ядро
4. Rooms (CRUD)
5. Students (CRUD)
6. Lesson Types (CRUD)
7. Schedule (просмотр, создание занятия)

### Фаза 3: Полный функционал
8. Groups (CRUD)
9. Schedule (редактирование, статусы, история)
10. Payments (CRUD, payment plans)

### Фаза 4: Улучшения
11. Statistics
12. Архивация везде
13. Полировка UI
