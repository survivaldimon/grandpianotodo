# Инструкция по применению миграции

## Что исправлено:

### 1. Баланс учеников при архивации
**Проблема:** При архивации ученика счётчик занятий (баланс) сбрасывался в 0, при разархивации восстанавливался.

**Причина:** VIEW `student_subscription_summary` фильтровал только неархивированных учеников (`WHERE archived_at IS NULL`).

**Решение:** Убрали фильтр из VIEW — теперь баланс показывается для всех учеников, независимо от статуса архивации.

### 2. Полное удаление ученика
**Новая функция:** Возможность полностью удалить ученика с сервера со всеми данными.

**Что удаляется:**
- ✅ Все занятия из расписания (lessons + lesson_history)
- ✅ Все оплаты (payments)
- ✅ Все подписки (subscriptions + subscription_members)
- ✅ Связи с предметами (student_subjects)
- ✅ Связи с преподавателями (student_teachers)
- ✅ Участие в группах (student_group_members)
- ✅ Сам ученик (students)

**Безопасность:**
- Кнопка доступна только для архивированных учеников
- Диалог с детальным предупреждением о том, что будет удалено
- Красная кнопка с подтверждением
- После удаления возврат к списку учеников

## Как применить миграцию:

### Вариант 1: Через Supabase Dashboard (рекомендуется)

1. Открой **Supabase Dashboard** → твой проект
2. Перейди в **SQL Editor**
3. Скопируй содержимое файла `/mnt/f/kabinet/supabase/migrations/20260105_fix_archived_balance_and_add_delete.sql`
4. Вставь в редактор SQL
5. Нажми **Run** (или `Ctrl+Enter`)

### Вариант 2: Через Supabase CLI

```bash
# В корне проекта
supabase db push
```

Миграция будет применена автоматически из папки `supabase/migrations/`.

## Проверка работы:

После применения миграции:

1. **Баланс при архивации:**
   - Архивируй ученика с балансом (например, 10 занятий)
   - Проверь, что баланс остался 10
   - Разархивируй — баланс должен остаться 10

2. **Полное удаление:**
   - Архивируй ученика
   - Открой его карточку
   - Нажми меню (⋮) → "Удалить навсегда"
   - Подтверди удаление
   - Проверь, что ученик полностью удалён из БД
   - Проверь, что его занятия удалились из расписания

## UI изменения:

**В карточке архивированного ученика:**
```
Меню (⋮):
├─ Разархивировать (зелёная)
└─ Удалить навсегда (красная) ← НОВОЕ
```

**Диалог удаления:**
- Иконка предупреждения
- Список того, что будет удалено
- Красный баннер "Это действие НЕОБРАТИМО!"
- Кнопки: "Отмена" / "Удалить навсегда" (красная)

## Код изменён в файлах:

- ✅ `supabase/migrations/20260105_fix_archived_balance_and_add_delete.sql` — миграция БД
- ✅ `lib/features/students/repositories/student_repository.dart` — метод `deleteCompletely()`
- ✅ `lib/features/students/providers/student_provider.dart` — контроллер с инвалидацией провайдеров
- ✅ `lib/features/students/screens/student_detail_screen.dart` — UI для удаления
