# СПЕЦИФИКАЦИЯ: Виртуальные занятия (Lesson Schedules)

## СТРОГО ОБЯЗАТЕЛЬНО

**Виртуальное занятие (lesson_schedule) должно выглядеть и работать в UI ТОЧНО ТАК ЖЕ как обычное занятие (lesson), но храниться как ОДНА запись в БД.**

---

## Принцип работы

### Одна запись = бесконечные занятия

```
lesson_schedules (1 запись)
    ↓
Отображается как занятие на КАЖДУЮ подходящую дату
    ↓
При проведении → создаётся реальная запись в lessons
```

### Пример

| Запись в БД | Что видит пользователь |
|-------------|------------------------|
| 1 запись lesson_schedule: "Пн 10:00, ученик Иванов" | Занятие в сетке расписания КАЖДЫЙ понедельник в 10:00 |

---

## UI: Как должно выглядеть

### В сетке расписания (all_rooms_schedule_screen.dart)

Виртуальное занятие отображается **В ТОЙ ЖЕ СЕТКЕ** что и реальные занятия:

```
┌─────────────────────────────────────┐
│  Кабинет 1  │  Кабинет 2  │  Кабинет 3  │
├─────────────────────────────────────┤
│ 09:00       │             │             │
│ ┌─────────┐ │             │             │
│ │ Иванов  │ │             │             │  ← Реальное занятие (lesson)
│ │ Музыка  │ │             │             │
│ └─────────┘ │             │             │
│ 10:00       │             │             │
│ ┌─────────┐ │             │             │
│ │ Петров  │ │             │             │  ← ВИРТУАЛЬНОЕ занятие (lesson_schedule)
│ │ Музыка  │ │             │             │     Выглядит ТОЧНО ТАК ЖЕ!
│ └─────────┘ │             │             │
└─────────────────────────────────────┘
```

### Визуальное отличие (минимальное)

| Тип | Отображение |
|-----|-------------|
| Реальное занятие (scheduled) | Обычная карточка |
| Реальное занятие (completed) | Зелёная галочка ✓ |
| **Виртуальное занятие** | Пунктирная граница ИЛИ иконка ↻ |

### При клике на виртуальное занятие

Открывается **ТА ЖЕ карточка занятия** что и для реальных:

- **Провести** → создаёт lesson со статусом `completed`, списывает оплату
- **Отменить** → создаёт lesson со статусом `cancelled`
- **Пропустить** → добавляет исключение в lesson_schedule_exceptions (занятие не создаётся)

---

## Логика отображения

### Загрузка данных для даты

```dart
// 1. Загружаем реальные занятия
final lessons = await lessonRepository.getByDate(date);

// 2. Загружаем виртуальные занятия (lesson_schedules), валидные для этой даты
final schedules = lessonSchedules.where((s) => s.isValidForDate(date));

// 3. Фильтруем: скрываем виртуальное если есть реальное
final virtualLessons = schedules.where((schedule) {
  final hasRealLesson = lessons.any((lesson) =>
    lesson.scheduleId == schedule.id
  );
  return !hasRealLesson;
});

// 4. Отображаем ОБА типа в одной сетке
```

### Рендеринг

```dart
Stack(
  children: [
    // Реальные занятия
    ...lessons.map((l) => _buildLessonCard(l)),
    // Виртуальные занятия (ТОТ ЖЕ виджет, только с флагом isVirtual)
    ...virtualLessons.map((s) => _buildLessonCard(s.toVirtualLesson(date))),
  ],
)
```

---

## ЗАПРЕЩЕНО

1. ❌ Показывать виртуальные занятия в ОТДЕЛЬНОЙ секции
2. ❌ Использовать другой UI для виртуальных занятий
3. ❌ Показывать виртуальные занятия как "слоты" или "брони"
4. ❌ Создавать отдельный экран для виртуальных занятий

---

## Модель данных

### lesson_schedules (постоянное расписание)

```sql
- id, institution_id, room_id, teacher_id, student_id
- day_of_week (1-7)
- start_time, end_time
- valid_from, valid_until (период действия)
- is_paused, pause_until (пауза)
- lesson_schedule_exceptions (пропущенные даты)
```

### lessons (реальные занятия)

```sql
- schedule_id -- ссылка на lesson_schedule, из которого создано
- ... все остальные поля занятия
```

---

## Создание занятия из расписания

При проведении виртуального занятия вызывается RPC:

```sql
SELECT create_lesson_from_schedule(
  p_schedule_id := 'xxx',
  p_date := '2026-01-20',
  p_status := 'completed'
);
```

Это создаёт реальную запись в `lessons` с `schedule_id` для связи.

---

## Итого

**Пользователь НЕ ДОЛЖЕН видеть разницу между реальным и виртуальным занятием в расписании.**

Единственное отличие — виртуальное занятие ещё не существует в БД как отдельная запись, пока его не проведут.
